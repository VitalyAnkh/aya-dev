# Early changelog

## v0.36

Major new features:

- Pattern matching expressions are now fully functional, including dependent pattern matching (`match ... as ... returns` in Coq)
  and JIT-compilation of them (which lifts them into global functions with lifted captures).<br/>
  The plugin is updated with supports for them.
- The `aya-lexer` language in `.aya.md` files, which highlights a code block with Aya lexer only.
  This is  good for demonstrating Aya features without having to make it valid Aya code.
- Replace the commonmark library with JetBrains' markdown library, which provides source code information in the AST,
  so we get actual error report for incorrect Aya inline code syntax (we could not have this because commonmark does not
  provide location).<br/>
  It also implements the commonmark spec incorrectly in a way that is IMO better: when it sees an HTML block,
  it will completely ignore it, rather than trying to also parse the parts that are not HTML tags.<br/>
  The old behavior can suffer from code like `<code>aa*bb</code>cc<code>dd*ee</code>ff`, which will be parsed as
  `<code>aa<em>bb</code>cc<code>dd</em>ee</code>ff` according to commonmark. I think this is VERY cringe.
  JetBrains markdown preserves them.
- The Aya inline code syntax is changed from `` `a`{x=y, z=k} `` into `` `a`(x:"y" z:"k") `` because of the limitations
  of the new markdown engine.
- Now writing terms inside a goal will get the type checker to infer the type of the term, and include them in the error message.
  They were totally ignored before.
- The pattern matching errors now have variable names, instead of de Bruijn indices.
- Aya now supports Spanish. In addition to `{? x ?}`, you can also use `{¿ x ?}`.
- Inactive maintainers are removed from related files.

Minor new features & user-visible bug fixes:

- The same unsolved meta is only reported once.
- `:load` libraries in REPL now correctly imports shapes.
- `:unimport` command in REPL, which unloads a module.
- Error report on classes is slightly more robust.
- `@suppress(Shadowing)` for suppressing name-shadowing warnings.
- Fix a bug in REPL pretty printing that prints constructors twice.
- When type checking a library, if a module takes more than 1.5 seconds, the time is printed.
- Unification side effects is slightly more controlled during lossy-unification.
  I spent an excessive amount of time on trying to implement an advanced version of this,
  but turns out it's completely not worth it.
- Instead of taking a supplier of the default value, the `invoke` methods generated by the JIT compiler
  now _make_ the default value by calling itself. This drastically reduces the size of generated code,
  while having almost the same performance.
- Slightly improve the concrete syntax and IDE-related code to allocate fewer objects.
- Constructor telescope explicitness is now correctly retrieved.
- Plain code blocks are now `<code class="">` instead of `<code class="Aya">`.

Internal changes:

- Instead of higher-order functions, we now use try-with-resources for cleanups (@mio-19),
  including pushing and popping variables into/from the context stack, `let` bindings,
  and pattern types in pattern matching. This can save a lot of memory, because JVM preserves all the stacks.
- The normalizer is now tail-recursion optimized at source level, which should be much more (100 times more) efficient,
  but much harder to debug, because we cannot unwind loops as we unwind stacks.
- The JIT compiler code generator now has an abstraction layer that can be implemented using bytecode generators
  (the classfile library) instead.
- Unused locally nameless operations are removed.
- Slightly fewer repeated normalization.
- JIT-compiled top level classes now have a `@CompiledAya` annotation, though it is not used,
  and we don't know what to do with it.
- When a JIT-compiled Java file failed to compile, we do not delete the file, even when `DELETE_JIT_JAVA_SOURCE` is set to true.
- A new utility to collect all free vars in a term.
- Negative tests output message is combined into one line for each test container class.
- `Jdg` is moved to the `syntax` submodule.

## v0.35

Breaking changes:

- Σ types are now binary rather than n-ary, and compilation is correctly implemented now

Major new features:

- Pattern matching expressions are now supported (since the locally nameless rewrite), in its most basic form (no dependent pattern matching yet).
- Pragma syntax is implemented, with `suppress` for suppressing warnings. You can now suppress only one warning: `@suppress(MostGeneralSolution)` for the "solving with not the most general solution" warning.
- JIT-compiled binaries are used right after being generated, even in the same library.
- Projection expressions are now type-checked (yes, we forgor).

Minor new features & user-visible bug fixes:

- Add `--no-prelude` flag to disable loading the prelude.
- When JIT-compiling a constant function, substitution of that function will be a constant function too.
- Now clauses and return types of functions are correctly pretty printed, no more de Bruijn indices shown to the user.
- Self-recursive function signatures are now correctly reported as errors.
- Cubical `coe` on pi, sigma, un-parameterized inductive types, and sorts are correctly normalized.
- Fix a long-standing bug of binary application term normalization.
- Libraries with user goals in them will not be JIT-compiled.
- The standard library has sum type and a couple of new lemmas on vectors now.
- A bunch of error reports are implemented.
- The "unsolved meta" error now is reported only once per meta.
- Improved type checker to handle more meta-typed terms.

Internal changes:

- No longer replace `MatchException` with `RuntimeException` because we are on Java 21 now.
- Update the Nix flake file.
- Code from jit-class branch is mostly cherry-picked to main.
- Pi and Sigma core terms are now combined and lots of code is shared.
- The APIs for implementing `hcom` (interval equality) is ready.

## v0.34

Semi-breaking changes:

- Revise the behavior of ambiguous exports -- we report errors on ambiguous exports now.
  Before, Aya will export all candidates, and error will occur only when you try to use one.
  But there is no way to resolve such ambiguity, so we now report errors earlier
- Kotlin stdlib is now in the binary dependencies of Aya due to transitive dependency
- Upgrade many dependencies

New features:

- Add `:debug-show-shapes` in REPL to show currently recognized shapes in the REPL context
- Preliminary support for classes, adding type checking for class declarations,
  class specializations, JIT-compilation, etc., but not yet for class instance resolution
- Add `:info` (alias: `:i`) command in REPL to show information about a name, similar to GHCi

Improvements to existing features including bug fixes:

- Correctly display emojis in Windows Terminal
- Improve error messages for unsolved metas thanks to @utensil and @HoshinoTented
- The jlink release will include compiled version of the std library
- Coercive subtyping now works from path to functions
- Better type checking for list literals with the presence of ambiguity
- Correctly pretty print `RuleReducer.Con`

## v0.33

We've started working on classes.

New features:

- Implement flex-flex unification
- Thorsten Altenkirch's QIIT is now correctly type-checked
- Now REPL and literate can in most cases display types of variables under
  the `NULL` normalization mode.
- The type of path constructors are now correctly displayed as equalities
- A more clever, context-based name generation for fresh variables
- JIT compiled code is substantially faster, we lazily compute the default value
- Share some instances in JIT compiled code
- `prelude` is now a thing, it will load basic stuff like naturals
- Quotients and `FMSet` in the library

Bug fixes:

- Modifiers of `def` are now serialized
- Indexed constructor return types are now correctly indexed
- Empty inductive types are now correctly treated in various places
- Submodules JIT now works

## v0.32

Breaking changes:

- Renamed the `data` keyword to `inductive`

New features:

- Implemented some missing features from previous Aya, including:
  - Pushing telescope for fn and constructors, not for data yet
- `partial` definitions will not be termination-checked and will not be unfolded,
  definitions that fail termination check will be marked as `partial`
- `ListTerm` now uses a persistent list, which should be more efficient

Bug fixes:

- Countless bugs related to `ownerArgs`/`dataArgs` issues, de Bruijn indices in
  patterns, 
- Resolving for `elim` now happens in resolving, not parsing
- Literate mode is not fully compatible with the old version
- Quotient inductive type fixes
- Some completely misguided error messages are now fixed
